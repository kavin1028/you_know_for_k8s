## åŸºäºPrometheusçš„å…¨æ–¹ä½ç›‘æ§å¹³å°--å‘Šè­¦ä¸­å¿ƒæ¶ˆæ¯è½¬å‘ç³»ç»ŸPrometheusAlert

#### 1.2ã€æ¶æ„åŸç†

Exports **-->** Prometheus **-->** Prometheus Rules **-->** Alertmanager **-->** webhook **-->** PrometheusAlert **-->** Routes **-->** ä¼å¾®/é’‰é’‰/é£ä¹¦...

#### 2.3ã€ä½¿ç”¨æ§åˆ¶å™¨æ–‡ä»¶éƒ¨ç½²

ä¸ºé˜²æ­¢æ¨¡ç‰ˆæ•°æ®ä¸¢å¤±ï¼Œå¢åŠ æŒ‚è½½é…ç½®

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prome-alert-data-pvc
  namespace: monitor
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: "nfs-storage"
  resources:
    requests:
      storage: 5Gi
```

**ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶**

```bash
$ wget https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/example/kubernetes/PrometheusAlert-Deployment.yaml
```

**ä¿®æ”¹é…ç½®æ–‡ä»¶**

```yaml
  app.conf: |
    #---------------------â†“å…¨å±€é…ç½®-----------------------
    appname = PrometheusAlert
    #ç™»å½•ç”¨æˆ·å
    login_user=admin
    #ç™»å½•å¯†ç 
    login_password=admin123
    #ç›‘å¬åœ°å€
    httpaddr = "0.0.0.0"
    #ç›‘å¬ç«¯å£
    httpport = 8080
...
    #æ•°æ®åº“é©±åŠ¨ï¼Œæ”¯æŒsqlite3ï¼Œmysql,postgreså¦‚ä½¿ç”¨mysqlæˆ–postgresï¼Œè¯·å¼€å¯db_host,db_port,db_user,db_password,db_nameçš„æ³¨é‡Š
    db_driver=mysql
    db_host=192.10.192.134
    db_port=3306
    db_user=root
    db_password=XXXXXXXXXXX
    db_name=prometheusalert
...
    #æ˜¯å¦å¼€å¯å‘Šè­¦è®°å½•å®šæ—¶åˆ é™¤ 0ä¸ºå…³é—­,1ä¸ºå¼€å¯
    RecordLive=1
    #å‘Šè­¦è®°å½•å®šæ—¶åˆ é™¤å‘¨æœŸï¼Œå•ä½å¤©
    RecordLiveDay=7
...
    #æ˜¯å¦å¼€å¯å¾®ä¿¡å‘Šè­¦é€šé“,å¯åŒæ—¶å¼€å§‹å¤šä¸ªé€šé“0ä¸ºå…³é—­,1ä¸ºå¼€å¯
    open-weixin=1
    #é»˜è®¤ä¼ä¸šå¾®ä¿¡æœºå™¨äººåœ°å€
    wxurl=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b3738de5-9f00-45de-9e3d-45e6309bc54c
...
        - name: prometheus-alert-db
          mountPath: /app/db

      - name: prometheus-alert-db
        persistentVolumeClaim:
          claimName: prome-alert-data-pvc
...
```

**é…ç½®Ingressè·¯ç”±**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-alert-ing
  namespace: monitor
  annotations:
    prometheus.io/http_probe: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: prometheusalert.kubernets.cn
      http:
        paths:
          - pathType: Prefix
            backend:
              service:
                name: prometheus-alert-center
                port:
                  number: 8080
            path: /
```

#### 2.4ã€é…ç½®PrometheusAlertä½¿ç”¨mysqlä½œä¸ºåç«¯æ•°æ®å­˜å‚¨

**éƒ¨ç½²mysqlåˆ°Kubernetesé›†ç¾¤ï¼š**

```yaml
## åˆ›å»ºç§˜é’¥
kubectl create secret generic mysql-root-password --from-literal=password=mysqlpwd123

## åˆ›å»ºpvc
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: nfs-storage
  
## åˆ›å»ºmysqlæ§åˆ¶å™¨
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: mysql
  name: mysql
  namespace: monitor
spec:
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: mysql:5.7
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-root-password
              key: password
          # å¦‚æœä½ ä¸æƒ³ä½¿ç”¨secretå¯¹è±¡ä¿å­˜mysqlç™»å½•å¯†ç ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æŒ‡å®šï¼Œç®€å•ç²—æš´æœªå°ä¸å¯
          #value: "123456"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysqlvolume
          mountPath: /var/lib/mysql
      volumes:
      - name: mysqlvolume
        # ä½¿ç”¨pvc
        persistentVolumeClaim:
          claimName: mysql-pvc
---
#å®šä¹‰mysqlçš„Service
apiVersion: v1
kind: Service
metadata:
  labels:
    app: svc-mysql
  name: svc-mysql
  namespace: monitor
spec:
  selector:
    app: mysql
  type: ClusterIP
  ports:
  - port: 3306
    protocol: TCP
    targetPort: 3306
```

**åˆ›å»ºæ•°æ®åº“**

```bash
# è·å– mysql pod
kubectl get pod -n monitor|grep mysql
# è¿›å…¥ mysql pod
kubectl exec -it mysql-6785bdcf-wsxhn -n monitor /bin/bash
# åœ¨ mysql pod å®¹å™¨å†…æ‰§è¡Œ
# ç™»å½• mysql
mysql -uroot -p
# åˆ›å»ºæ•°æ®åº“ prometheusalert
CREATE DATABASE prometheusalert CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

**è·å– prometheusalert.sql**

```bash
# è·å–pod
kubectl get pod -n monitor|grep prometheus
# è¿›å…¥pod
kubectl exec -it prometheus-alert-center-5d7dfb8c99-h78z4 -n monitor /bin/sh
# æ‹·è´æ–‡ä»¶
kubectl cp monitor/prometheus-alert-center-5d7dfb8c99-l48gw:/app/db/prometheusalert.sql /mnt/data-s3-fs/prometheusalert-mysql/data/prometheusalert.sql
```

**å¯¼å…¥sql**

åˆ©ç”¨Navicatæˆ–å‘½ä»¤è¡Œå°†dbç›®å½•ä¸­çš„ prometheusalert.sql å¯¼å…¥æ•°æ®åº“prometheusalertï¼š

```python
# è¿›å…¥ mysql pod
kubectl exec -it mysql-6785bdcf-wsxhn -n monitor /bin/bash
# åœ¨ mysql pod å®¹å™¨å†…æ‰§è¡Œ
# åˆ‡æ¢åˆ° mysql æ•°æ®ç›®å½•ä¸‹
cd /var/lib/mysql
# ç™»å½• mysql
mysql -uroot -p
use prometheusalert
source prometheusalert.sql
```

### ä¸‰ã€prometheusAlerté…ç½®ç®¡ç†

#### 3.1ã€ç¼–è¾‘è‡ªå®šä¹‰æ¨¡ç‰ˆ

**æ¨¡ç‰ˆå†…å®¹ï¼š**

```javascript
{{ $var := .externalURL}}{{ range $k,$v:=.alerts }}{{if eq $v.status "resolved"}}[PROMETHEUS-æ¢å¤ä¿¡æ¯]({{$v.generatorURL}})
> **[{{$v.labels.alertname}}]({{$var}})**âœ…
> <font color="info">å‘Šè­¦çº§åˆ«:</font> {{$v.labels.severity}}
> <font color="info">å¼€å§‹æ—¶é—´:</font> {{GetCSTtime $v.startsAt}}
> <font color="info">ç»“æŸæ—¶é—´:</font> {{GetCSTtime $v.endsAt}}
> <font color="info">å‘½åç©ºé—´:</font> {{$v.labels.namespace}}
> <font color="info">å®ä¾‹åç§°:</font> {{$v.labels.pod}}
> <font color="info">å®ä¾‹åœ°å€:</font> {{$v.labels.instance}}
> <font color="info">**{{$v.annotations.description}}**</font>{{else}}[PROMETHEUS-å‘Šè­¦ä¿¡æ¯]({{$v.generatorURL}})
> **[{{$v.labels.alertname}}]({{$var}})**ğŸ”¥
> <font color="#FF0000">å‘Šè­¦çº§åˆ«:</font> {{$v.labels.severity}}
> <font color="#FF0000">å¼€å§‹æ—¶é—´:</font> {{GetCSTtime $v.startsAt}}
> <font color="#FF0000">å‘½åç©ºé—´:</font> {{$v.labels.namespace}}
> <font color="#FF0000">å®ä¾‹åç§°:</font> {{$v.labels.pod}}
> <font color="#FF0000">å®ä¾‹åœ°å€:</font> {{$v.labels.instance}}
> <font color="#FF0000">**{{$v.annotations.description}}**</font>{{end}}{{ end }}
{{ $urimsg:=""}}{{ range $key,$value:=.commonLabels }}{{$urimsg =  print $urimsg $key "%3D%22" $value "%22%2C" }}{{end}}[âœç‚¹æˆ‘å±è”½è¯¥å‘Šè­¦](http://alertmanager.kubernets.cn/#/silences/new?filter=%7B{{SplitString $urimsg 0 -3}}%7D)
```

#### 3.2ã€æ–°å¢è‡ªå®šä¹‰æ¨¡ç‰ˆ

**æ¨¡æ¿å†…å®¹ï¼š**

```javascript
{{ $var := .externalURL}}{{ range $k,$v:=.alerts }}{{if eq $v.status "resolved"}}[PROMETHEUS-æ¢å¤ä¿¡æ¯]({{$v.generatorURL}})
> **[{{$v.labels.alertname}}]({{$var}})**âœ…
> <font color="info">å‘Šè­¦çº§åˆ«:</font> {{$v.labels.severity}}
> <font color="info">å½“å‰çŠ¶æ€:</font> **<font color="#67C23A">å·²æ¢å¤</font>**
> <font color="info">å¼€å§‹æ—¶é—´:</font> {{GetCSTtime $v.startsAt}}
> <font color="info">ç»“æŸæ—¶é—´:</font> {{GetCSTtime $v.endsAt}}
> <font color="info">å®ä¾‹åœ°å€:</font> {{$v.labels.instance}}
> <font color="info">**{{$v.annotations.description}}**</font>{{else}}[PROMETHEUS-å‘Šè­¦ä¿¡æ¯]({{$v.generatorURL}})
> **[{{$v.labels.alertname}}]({{$var}})**ğŸ”¥
> <font color="#FF0000">å‘Šè­¦çº§åˆ«:</font> {{$v.labels.severity}}
> <font color="#FF0000">å½“å‰çŠ¶æ€:</font> **<font color="#E6A23C">éœ€è¦å¤„ç†</font>**
> <font color="#FF0000">å¼€å§‹æ—¶é—´:</font> {{GetCSTtime $v.startsAt}}
> <font color="#FF0000">å®ä¾‹åœ°å€:</font> {{$v.labels.instance}}
> <font color="#FF0000">**{{$v.annotations.description}}**</font>{{end}}{{ end }}
{{ $urimsg:=""}}{{ range $key,$value:=.commonLabels }}{{$urimsg =  print $urimsg $key "%3D%22" $value "%22%2C" }}{{end}}[âœç‚¹æˆ‘å±è”½è¯¥å‘Šè­¦](http://alertmanager.kubernets.cn/#/silences/new?filter=%7B{{SplitString $urimsg 0 -3}}%7D)
```

#### 3.3ã€å‘Šè­¦æµ‹è¯•

å‘Šè­¦ç®¡ç† --> å‘Šè­¦æµ‹è¯• --> ä¼ä¸šå¾®ä¿¡ --> ä¼ä¸šå¾®ä¿¡æŸ¥çœ‹æµ‹è¯•æ¶ˆæ¯ï¼›

#### 3.4ã€å‘Šè­¦è·¯ç”±

<img src="D:/MARKDOWN_FILES/images/image-20230529150821866.png" style="zoom:80%;" />

å¦‚æœä¸€ä¸ªå°ä¼™ä¼´ä¸‹æœ‰å¾ˆå¤šæœºå™¨èµ„æºï¼Œå¦‚ä½•æ­£åˆ™åŒ¹é…ï¼Ÿ

### å››ã€é…ç½®Alertmanageræ¥å…¥PrometheusAlert

æ›´æ–°alertmanageré…ç½®ï¼Œå°†æ‰€æœ‰çš„å‘Šè­¦å‡æŒ‡å‘å‘Šè­¦åˆ†å‘å¹³å°

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitor
data:
  alertmanager.yml: |-
    global:
      resolve_timeout: 1m
      smtp_smarthost: 'smtp.exmail.qq.com:465'     # é‚®ç®±æœåŠ¡å™¨çš„SMTPä¸»æœºé…ç½®
      smtp_from: 'zhdya@zhdya.cn'    # å‘é€é‚®ä»¶ä¸»é¢˜
      smtp_auth_username: 'zhdya@zhdya.cn'      # ç™»å½•ç”¨æˆ·å
      smtp_auth_password: 'yfXBXXXXX3DwYTjn'    # æ­¤å¤„çš„auth passwordæ˜¯é‚®ç®±çš„ç¬¬ä¸‰æ–¹ç™»å½•æˆæƒå¯†ç ï¼Œè€Œéç”¨æˆ·å¯†ç 
      smtp_require_tls: false           # æœ‰äº›é‚®ç®±éœ€è¦å¼€å¯æ­¤é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ä¼å¾®é‚®ç®±ï¼Œä»…åšæµ‹è¯•ï¼Œä¸éœ€è¦å¼€å¯æ­¤åŠŸèƒ½ã€‚

    templates:
      - '/etc/alertmanager/*.tmpl'
    route:
      group_by: ['env','instance','type','group','job','alertname','cluster']
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 10m
      receiver: 'webhook'

    receivers:
    - name: 'webhook'
      webhook_configs:
      - url: 'http://prometheus-alert-center.monitor.svc:8080/prometheusalert?type=wx&tpl=prometheus-wx&wxurqq.com/cgi-bin/webhook/send?key=71c0a6f0-43a0-4ecf-b8c9-52aff88f3b68&at=ZhangDaDan,ZHDYA'
        send_resolved: true

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'dev', 'instance']

  wechat.tmpl: |-
    {{ define "wechat.default.message" }}
    {{- if gt (len .Alerts.Firing) 0 -}}
    {{- range $index, $alert := .Alerts -}}
    {{- if eq $index 0 }}
    ========= ç›‘æ§æŠ¥è­¦ =========
    å‘Šè­¦çŠ¶æ€ï¼š{{   .Status }}
    å‘Šè­¦çº§åˆ«ï¼š{{ .Labels.severity }}
    å‘Šè­¦ç±»å‹ï¼š{{ $alert.Labels.alertname }}
    æ•…éšœä¸»æœº: {{ $alert.Labels.instance }}
    å‘Šè­¦ä¸»é¢˜: {{ $alert.Annotations.summary }}
    å‘Šè­¦è¯¦æƒ…: {{ $alert.Annotations.message }}{{ $alert.Annotations.description}};
    è§¦å‘é˜€å€¼ï¼š{{ .Annotations.value }}
    æ•…éšœæ—¶é—´: {{ ($alert.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
    ========= = end =  =========
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if gt (len .Alerts.Resolved) 0 -}}
    {{- range $index, $alert := .Alerts -}}
    {{- if eq $index 0 }}
    ========= å‘Šè­¦æ¢å¤ =========
    å‘Šè­¦ç±»å‹ï¼š{{ .Labels.alertname }}
    å‘Šè­¦çŠ¶æ€ï¼š{{   .Status }}
    å‘Šè­¦ä¸»é¢˜: {{ $alert.Annotations.summary }}
    å‘Šè­¦è¯¦æƒ…: {{ $alert.Annotations.message }}{{ $alert.Annotations.description}};
    æ•…éšœæ—¶é—´: {{ ($alert.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
    æ¢å¤æ—¶é—´: {{ ($alert.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
    {{- if gt (len $alert.Labels.instance) 0 }}
    å®ä¾‹ä¿¡æ¯: {{ $alert.Labels.instance }}
    {{- end }}
    ========= = end =  =========
    {{- end }}
    {{- end }}
    {{- end }}
    {{- end }}

  email.tmpl: |-
    {{ define "email.from" }}xxx.com{{ end }}
    {{ define "email.to" }}xxx.com{{ end }}
    {{ define "email.to.html" }}
    {{- if gt (len .Alerts.Firing) 0 -}}
    {{ range .Alerts }}
    ========= ç›‘æ§æŠ¥è­¦ =========<br>
    å‘Šè­¦ç¨‹åº: prometheus_alert <br>
    å‘Šè­¦çº§åˆ«: {{ .Labels.severity }} <br>
    å‘Šè­¦ç±»å‹: {{ .Labels.alertname }} <br>
    å‘Šè­¦ä¸»æœº: {{ .Labels.instance }} <br>
    å‘Šè­¦ä¸»é¢˜: {{ .Annotations.summary }}  <br>
    å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }} <br>
    è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }} <br>
    ========= = end =  =========<br>
    {{ end }}{{ end -}}

    {{- if gt (len .Alerts.Resolved) 0 -}}
    {{ range .Alerts }}
    ========= å‘Šè­¦æ¢å¤ =========<br>
    å‘Šè­¦ç¨‹åº: prometheus_alert <br>
    å‘Šè­¦çº§åˆ«: {{ .Labels.severity }} <br>
    å‘Šè­¦ç±»å‹: {{ .Labels.alertname }} <br>
    å‘Šè­¦ä¸»æœº: {{ .Labels.instance }} <br>
    å‘Šè­¦ä¸»é¢˜: {{ .Annotations.summary }} <br>
    å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }} <br>
    è§¦å‘æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }} <br>
    æ¢å¤æ—¶é—´: {{ .EndsAt.Format "2006-01-02 15:04:05" }} <br>
    ========= = end =  =========<br>
    {{ end }}{{ end -}}

    {{- end }}
```

æ¥å£è¯´æ˜ï¼š

```yaml
    receivers:
    - name: 'webhook'
      webhook_configs:
      - url: 'http://prometheus-alert-center.monitor.svc:8080/prometheusalert?type=wx&tpl=prometheus-wx&wxurqq.com/cgi-bin/webhook/send?key=71c0a6f0-43a0-4ecf-b8c9-52aff88f3b68&at=ZhangDaDan,ZHDYA'

## æ¥å£è¯´æ˜ï¼š
/prometheusalert   #è‡ªå®šä¹‰æ¨¡ç‰ˆæ¥å£ï¼Œå¯é€šè¿‡Dashboardè‡ªå®šä¹‰æ¨¡ç‰ˆåï¼Œæ”¯æŒä»»æ„WebHookæ¥å…¥
type=?ï¼šæŒ‡å®šæ¶ˆæ¯è½¬å‘çš„ç›®æ ‡ç±»å‹ï¼Œå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ç­‰ï¼›è¯¥å‚æ•°ä¸ºå¿…é€‰å‚æ•°
ç›®å‰æ”¯æŒçš„å€¼ï¼š
dd é’‰é’‰
wx ä¼ä¸šå¾®ä¿¡
workwechat ä¼ä¸šå¾®ä¿¡åº”ç”¨
fs é£ä¹¦
webhook WebHook
txdx è…¾è®¯äº‘çŸ­ä¿¡
txdh è…¾è®¯äº‘ç”µè¯
alydx é˜¿é‡Œäº‘çŸ­ä¿¡
alydh é˜¿é‡Œäº‘ç”µè¯
hwdx åä¸ºäº‘çŸ­ä¿¡
bddx ç™¾åº¦äº‘çŸ­ä¿¡
rlydh å®¹è”äº‘ç”µè¯
7moordx ä¸ƒé™ŒçŸ­ä¿¡
7moordh ä¸ƒé™Œè¯­éŸ³ç”µè¯
email Email
tg Telegram
rl ç™¾åº¦Hi(å¦‚æµ)

tpl=?: æŒ‡å®šæ¶ˆæ¯æ‰€ä½¿ç”¨çš„æ¨¡ç‰ˆï¼Œå¦‚prometheus-dd(Prometheusé’ˆå¯¹é’‰é’‰çš„æ¨¡æ¿)ï¼›æ¨¡ç‰ˆå¯ä»¥å»PrometheusAlert é¡µé¢çš„æ¨¡ç‰ˆç®¡ç†-->è‡ªå®šä¹‰æ¨¡æ¿é¡µé¢æŸ¥çœ‹æˆ–æ–°å»º;è¯¥å‚æ•°ä¸ºå¿…é€‰å‚æ•°
ddurl=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„é’‰é’‰æœºå™¨äººåœ°å€ï¼Œå¦‚éœ€è¦å¤šä¸ªåœ°å€å¯ä»¥é€šè¿‡,åˆ†å‰²ï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=ddçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä»app.confä¸­è·å–é»˜è®¤é…ç½®
wxurl=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„ä¼ä¸šå¾®ä¿¡æœºå™¨äººåœ°å€ï¼Œå¦‚éœ€è¦å¤šä¸ªåœ°å€å¯ä»¥é€šè¿‡,åˆ†å‰²ï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=wxçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä»app.confä¸­è·å–é»˜è®¤é…ç½®
fsurl=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„é£ä¹¦æœºå™¨äººåœ°å€ï¼Œå¦‚éœ€è¦å¤šä¸ªåœ°å€å¯ä»¥é€šè¿‡,åˆ†å‰²ï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=fsçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä»app.confä¸­è·å–é»˜è®¤é…ç½®
phone=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„æ‰‹æœºå·ï¼Œå¦‚éœ€è¦å¤šä¸ªå·ç å¯ä»¥é€šè¿‡,åˆ†å‰²ï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=txdx | hwdx | bddx | alydx | txdh | alydh | rlydh | 7moordx | 7moordhçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä»app.confä¸­è·å–é»˜è®¤é…ç½®
email=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„emailåœ°å€ï¼Œå¦‚éœ€è¦å¤šä¸ªemailå¯ä»¥é€šè¿‡,åˆ†å‰²ï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=emailçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä»app.confä¸­è·å–é»˜è®¤é…ç½®
groupid=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„groupidï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=rlçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä»app.confä¸­è·å–é»˜è®¤é…ç½®
webhook=?ï¼šæŒ‡å®šPrometheusAlertå‘é€æ¶ˆæ¯çš„webhookï¼Œè¯¥å‚æ•°éœ€è¦é…åˆtype=webhookçš„æ¨¡ç‰ˆä½¿ç”¨;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°
at=?ï¼šé’‰é’‰æœºå™¨äººã€ä¼ä¸šå¾®ä¿¡æœºå™¨äººå¼€å¯@æŸäººçš„åŠŸèƒ½ï¼Œå¦‚éœ€æ·»åŠ å¤šä¸ª@ç›®æ ‡ï¼Œç”¨,å·åˆ†å‰²å³å¯ã€‚æ­¤å¤„éœ€æ³¨æ„ï¼šé’‰é’‰@ä½¿ç”¨çš„æ˜¯æ‰‹æœºå·ç ï¼Œä¼ä¸šå¾®ä¿¡æœºå™¨äºº@ä½¿ç”¨çš„æ˜¯ç”¨æˆ·å¸å·ã€‚;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°
rr=?ï¼šè¯¥å‚æ•°ä¸ºå¼€å¯éšæœºè½®è¯¢ï¼Œç›®å‰ä»…é’ˆå¯¹ddurlï¼Œfsurlï¼Œwxurlæœ‰æ•ˆï¼Œé»˜è®¤æƒ…å†µä¸‹å¦‚æœä¸Šè¿°Urlé…ç½®çš„æ˜¯å¤šä¸ªåœ°å€ï¼Œåˆ™å¤šä¸ªåœ°å€å…¨éƒ¨å‘é€ï¼Œå¦‚å¼€å¯è¯¥é€‰é¡¹ï¼Œåˆ™ä»å¤šä¸ªåœ°å€ä¸­éšæœºå–ä¸€ä¸ªåœ°å€å‘é€ï¼Œä¸»è¦æ˜¯ä¸ºäº†é¿å…æ¶ˆæ¯å‘é€é¢‘ç‡è¿‡é«˜å¯¼è‡´è§¦å‘éƒ¨åˆ†æœºå™¨äººæ‹¦æˆªæ¶ˆæ¯ã€‚;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°
split=?ï¼šè¯¥å‚æ•°ä»…é’ˆå¯¹Prometheuså‘Šè­¦æ¶ˆæ¯æœ‰æ•ˆï¼Œä½œç”¨æ˜¯å°†Prometheusåˆ†ç»„æ¶ˆæ¯æ‹†åˆ†æˆå•æ¡å‘é€ã€‚é»˜è®¤å¼€å¯ï¼Œå¦‚æœPrometheusä¸€æ¬¡å‘Šè­¦é™„å¸¦çš„åŒåˆ†ç»„çš„å‘Šè­¦æ¶ˆæ¯æ¡æ•°è¿‡å¤šï¼Œå¯èƒ½ä¼šå¯¼è‡´å‘Šè­¦æ¶ˆæ¯ä½“è¿‡å¤§ã€‚å¦‚éœ€å…³é—­è¯·åœ¨urlä¸­åŠ å…¥split=false;è¯¥å‚æ•°ä¸ºå¯é€‰å‚æ•°
æ³¨æ„ï¼šæ­¤å‚æ•°å¦‚è®¾ç½®ä¸ºsplit=falseï¼Œåˆ™PrometheusAlert webé¡µé¢çš„è·¯ç”±å’Œå‘Šè­¦è®°å½•ç­‰åŠŸèƒ½å°†è‡ªåŠ¨å…³é—­ï¼Œè¯·è°¨æ…ã€‚
```

çƒ­åŠ è½½alertmanageræœåŠ¡ï¼š

```bash
$ curl -XPOST http://alertmanager.kubernets.cn/-/reload
```

### äº”ã€æµ‹è¯•éªŒè¯

éªŒè¯æ‰€æœ‰çš„å‘Šè­¦æ˜¯å¦å‘é€åˆ°æŒ‡å®šçš„ç¾¤ç»„ï¼š

```bash
## é»˜è®¤æ ‡ç­¾èµ°é»˜è®¤è·¯ç”±
$ curl -XPOST -H 'Content-Type: application/json' http://alertmanager.kubernets.cn/api/v1/alerts -d '[{"labels":{"hostname":"zhdya"},"annotations":{"summary":"This is a test alert"}}]'
```

éªŒè¯æŒ‡å®šæ ‡ç­¾å‘Šè­¦åˆ°æŒ‡å®šçš„ç¾¤ç»„ï¼š

```bash
## é»˜è®¤å°†å‘Šè­¦åˆ†å‘åˆ°æŒ‡å®šçš„å‘Šè­¦ç»„ï¼Œå¹¶ä¹Ÿéœ€è¦åœ¨DEVOPSç¾¤ç»„ä¸­å±•ç¤º
$ curl -XPOST -H 'Content-Type: application/json' http://alertmanager.kubernets.cn/api/v1/alerts -d '[{"labels":{"hostname":"hello"},"annotations":{"summary":"This is a test alert"}}]'
```
